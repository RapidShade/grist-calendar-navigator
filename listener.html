<!DOCTYPE html>
<html>
<head>
  <script>
    // File: navigator-listener.js
    // Description: Tiny Grist plugin widget that reads the grist-navigate hash and moves to the correct record
    
    (function() {
      // Helper to extract info from the URL hash
      function parseGristNavigateHash() {
        const hash = window.location.hash;
        const prefix = '#grist-navigate:';
        if (!hash.startsWith(prefix)) {
          console.log('RapidShade: No matching grist-navigate hash found.');
          return null;
        }
        const parts = hash.slice(prefix.length).split(':');
        if (parts.length !== 2) {
          console.warn('RapidShade: Invalid grist-navigate format');
          return null;
        }
        return {
          tableId: parts[0],
          rowId: parseInt(parts[1], 10)
        };
      }
    
      function clearHash() {
        history.replaceState('', document.title, window.location.pathname + window.location.search);
      }
    
      window.addEventListener('load', async () => {
        console.log('RapidShade: Navigator Listener Loaded');
        const info = parseGristNavigateHash();
        if (!info) return;
    
        // Wait until grist object is available
        const waitForGrist = new Promise(resolve => {
          const interval = setInterval(() => {
            if (window.grist && window.grist.setCursorPos) {
              clearInterval(interval);
              resolve(window.grist);
            }
          }, 100);
        });
    
        const grist = await waitForGrist;
        console.log(`RapidShade: Navigating to ${info.tableId} / Row ${info.rowId}`);
    
        try {
          await grist.setCursorPos(info.tableId, info.rowId);
          console.log('RapidShade: Navigation complete.');
          clearHash();
        } catch (err) {
          console.error('RapidShade: Failed to navigate:', err);
        }
      });
    })();

  </script>
</head>
<body>
  <p>Navigation listener loaded.</p>
</body>
</html>
