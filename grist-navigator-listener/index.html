<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Grist Navigator Listener</title>
</head>
<body>
<script>
  console.log("ðŸ” Loading Grist Navigator Listener v2.32");

  // Setup a promise to wait for the grist API
  const getGristApi = new Promise((resolve, reject) => {
    let attempts = 0;

    function requestAPI() {
      if (attempts++ > 30) {
        reject("âŒ Grist API not received after multiple attempts.");
        return;
      }
      console.log("ðŸ“¡ Requesting gristDocAPI via postMessage...");
      window.parent.postMessage({type: "grist", message: "requestAPI"}, "*");
    }

    // Listen for Grist response
    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === "grist" && event.data.api) {
        console.log("âœ… Received gristDocAPI via postMessage");
        resolve(event.data.api);
      }
    });

    // Request repeatedly (in case first message is missed)
    const interval = setInterval(requestAPI, 500);
    setTimeout(() => clearInterval(interval), 16000);  // Stop after 16s
  });

  getGristApi.then((api) => {
    console.log("ðŸ“Œ Grist API ready");

    // Example: Navigate to table EVENTS, rowId 9
    api.setCursor("EVENTS", 9);
  }).catch((err) => {
    console.error(err);
  });
</script>

</body>
</html>
