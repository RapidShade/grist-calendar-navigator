<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Grist Navigator Listener</title>
</head>
<body style="display:none">
  <script>
    console.log("üîÅ Loading Grist Navigator Listener v2.30");

    let gristAPI = null;

    // Request Grist API via postMessage
    function requestGristAPI() {
      console.log("üì° Requesting gristDocAPI via postMessage...");
      window.parent.postMessage({ type: "gristDocAPI" }, "*");
    }

    // Handle message from Grist
    window.addEventListener("message", (event) => {
      if (event.data?.gristDocAPI) {
        gristAPI = event.data.gristDocAPI;
        console.log("‚úÖ gristDocAPI injected");

        handleNavigationHash();
      }
    });

    // Extract hash and call gristAPI.setCursor
    function handleNavigationHash() {
      const hash = window.location.hash;
      console.log("üîé URL hash:", hash);
      const match = hash.match(/^#grist-navigate:([A-Za-z0-9_]+):(\d+)$/);
      if (match) {
        const [, table, rowStr] = match;
        const rowId = parseInt(rowStr, 10);
        console.log(`‚û°Ô∏è Navigating to ${table} ‚Üí row ${rowId}`);
        gristAPI.setCursor(table, rowId)
          .then(() => console.log("‚úÖ Cursor set successfully"))
          .catch(err => console.error("‚ùå Error setting cursor:", err));
      } else {
        console.warn("‚ö†Ô∏è No valid #grist-navigate:TABLE:ID hash found.");
      }
    }

    // Retry every 500ms until API is received
    requestGristAPI();
    const retry = setInterval(() => {
      if (gristAPI) {
        clearInterval(retry);
      } else {
        console.log("‚è≥ Waiting for gristDocAPI...");
        requestGristAPI();
      }
    }, 500);
  </script>
</body>
</html>
