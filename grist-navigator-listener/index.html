<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Grist Navigator Listener</title>
</head>
<body>
  <script>
    console.log("üîÅ Loading Grist Navigator Listener v2.32");

    async function getGristDocAPI() {
      return new Promise((resolve) => {
        // Try modern injection
        if (window.grist) {
          console.log("‚úÖ Found window.grist");
          resolve(window.grist);
          return;
        }

        // Fallback to postMessage
        console.log("üì° Requesting gristDocAPI via postMessage (iframe mode)...");
        window.parent.postMessage({ type: "getGristDocAPI" }, "*");

        window.addEventListener("message", function listener(event) {
          if (event.data && event.data.type === "gristDocAPI") {
            console.log("‚úÖ Received gristDocAPI via postMessage");
            window.removeEventListener("message", listener);
            resolve(event.data.api);
          }
        });

        // Optional: Timeout fallback
        setTimeout(() => {
          console.warn("‚ö†Ô∏è No gristDocAPI received after timeout.");
        }, 5000);
      });
    }

    async function run() {
      const api = await getGristDocAPI();
      if (!api) {
        console.error("‚ùå gristDocAPI is undefined.");
        return;
      }

      const hash = window.location.hash;
      const match = hash.match(/grist-navigate:([^:]+):(\d+)/);
      if (!match) {
        console.warn("‚ö†Ô∏è No grist-navigate in hash:", hash);
        return;
      }

      const [, table, rowId] = match;
      console.log(`‚û°Ô∏è Navigating to table ${table}, row ${rowId}`);

      try {
        await api.navigateToTable(table);
        await new Promise((res) => setTimeout(res, 300)); // Small delay
        await api.setCursor(table, parseInt(rowId, 10));
        console.log("‚úÖ Navigation complete.");
      } catch (e) {
        console.error("‚ùå Navigation failed:", e);
      }
    }

    run();
  </script>
</body>
</html>
