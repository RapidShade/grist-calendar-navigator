<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Grist Navigator Listener</title>
</head>
<body style="display:none">
  <script>
    console.log("üîÅ Loading Grist Navigator Listener v2.31");

    let gristAPI = null;

    // Listen for Grist injecting the API
    window.addEventListener("message", async (event) => {
      if (event?.data?.gristDocAPI && !gristAPI) {
        gristAPI = event.data.gristDocAPI;
        console.log("‚úÖ gristDocAPI received");

        const hash = window.location.hash;
        console.log("üîç URL hash:", hash);
        const match = hash.match(/^#grist-navigate:([A-Za-z0-9_]+):(\d+)$/);
        if (match) {
          const [, table, rowStr] = match;
          const rowId = parseInt(rowStr, 10);
          console.log(`‚û°Ô∏è Navigating to table: ${table}, row: ${rowId}`);
          try {
            await gristAPI.setCursor(table, rowId);
            console.log("‚úÖ Cursor set!");
          } catch (err) {
            console.error("‚ùå Failed to set cursor:", err);
          }
        } else {
          console.warn("‚ö†Ô∏è Invalid or missing hash.");
        }
      }
    });

    console.log("‚è≥ Waiting for gristDocAPI via postMessage (iframe mode)...");
  </script>
</body>
</html>
