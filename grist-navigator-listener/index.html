<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grist Navigator Listener</title>
</head>
<body style="display:none">
  <script>
    console.log("RapidShade: Navigator Listener v2.20");

    let gristAPI = null;

    function tryCursorNavigation(api) {
      const hash = window.location.hash;
      const match = hash.match(/^#grist-navigate:([A-Za-z0-9_]+):(\d+)$/);
      if (match) {
        const [, table, rowIdStr] = match;
        const rowId = parseInt(rowIdStr, 10);
        console.log(`RapidShade: Navigating to ${table}:${rowId}`);
        api.setCursor(table, rowId)
          .then(() => console.log("✅ Cursor set"))
          .catch(err => console.error("❌ Failed to set cursor", err));
      } else {
        console.warn("⚠️ No valid grist-navigate hash");
      }
    }

    window.addEventListener("message", (event) => {
      if (event.data && event.data.gristDocAPI) {
        gristAPI = event.data.gristDocAPI;
        console.log("✅ gristDocAPI received");
        tryCursorNavigation(gristAPI);
      }
    });

    setTimeout(() => {
      console.log("🔁 Requesting gristDocAPI from parent");
      window.parent.postMessage({ type: "gristDocAPI" }, "*");
    }, 100);
  </script>
</body>
</html>

