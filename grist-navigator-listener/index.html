<script>
  console.log("RapidShade: Navigator Listener v1.51");

  function attemptCursor() {
    const hash = window.location.hash;
    console.log("RapidShade: Current hash is", hash);
    const match = hash.match(/^#grist-navigate:([A-Za-z0-9_]+):([0-9]+)$/);
    if (!match) {
      console.warn("RapidShade: ‚ö†Ô∏è No matching navigation hash");
      return;
    }

    const [, table, rowIdStr] = match;
    const rowId = parseInt(rowIdStr, 10);
    console.log(`RapidShade: Parsed table=${table}, row=${rowId}`);

    const api = window.grist || null;
    if (!api || typeof api.setCursor !== "function") {
      console.error("RapidShade: ‚ùå No grist API available");
      return;
    }

    api.setCursor(table, rowId)
      .then(() => console.log("RapidShade: ‚úÖ Cursor set successfully"))
      .catch(err => console.error("RapidShade: ‚ùå Error setting cursor", err));
  }

  // 1. Try direct access to Grist API (works in some widget contexts)
  if (window.grist && typeof window.grist.setCursor === "function") {
    console.log("RapidShade: üéØ Found window.grist directly");
    attemptCursor();
  } else {
    // 2. Fallback to postMessage-based injection
    console.log("RapidShade: üîÅ Posting message to parent");
    window.parent.postMessage({ type: 'gristDocAPI' }, '*');

    window.addEventListener("message", (event) => {
      if (event.data && event.data.gristDocAPI) {
        const injected = event.data.gristDocAPI;
        if (typeof injected.setCursor === "function") {
          console.log("RapidShade: ‚úÖ Grist API injected via message");
          injected.setCursor = injected.setCursor.bind(injected); // bind safety
          window.grist = injected;
          attemptCursor();
        } else {
          console.error("RapidShade: ‚ùå Injected API missing setCursor");
        }
      }
    });
  }
</script>
