<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grist Navigator Listener</title>
</head>
<body>
  <script>
    console.log("ğŸ” Loading Grist Navigator Listener v2.22");

    async function getGristDocAPI() {
      if (window.grist) {
        console.log("âœ… gristDocAPI available via window.grist (inline mode)");
        return window.grist;
      }

      return new Promise((resolve) => {
        console.log("â³ Waiting for gristDocAPI via postMessage (iframe mode)...");
        window.addEventListener("message", function handler(event) {
          if (event.data && event.data.gristDocAPI) {
            console.log("âœ… gristDocAPI received via postMessage");
            window.removeEventListener("message", handler);
            resolve(event.data.gristDocAPI);
          }
        });

        window.parent?.postMessage({ type: "getGristDocAPI" }, "*");
      });
    }

    (async () => {
      const grist = await getGristDocAPI();

      grist.onRecord(function(record) {
        console.log("ğŸ“¡ Received record:", record);

        const target = record.Target1;
        const key = record.TargetKey1;

        if (target && key !== undefined && key !== null) {
          const fragment = `#grist-navigate:${target}:${key}`;
          console.log("ğŸ” Posting message to parent:", fragment);
          window.parent?.postMessage(fragment, "*");
        } else {
          console.warn("âš ï¸ No valid Target1 or TargetKey1 in record:", record);
        }
      });
    })();
  </script>
</body>
</html>
